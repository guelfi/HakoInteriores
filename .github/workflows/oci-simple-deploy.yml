name: oci-simple-deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check SSH credentials
        id: check
        env:
          SSH_HOST: ${{ secrets.SSH_HOST || vars.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER || vars.SSH_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY || vars.SSH_PRIVATE_KEY }}
        run: |
          missing=()
          for v in SSH_HOST SSH_USER SSH_PRIVATE_KEY; do [ -z "${!v}" ] && missing+=("$v"); done
          if [ ${#missing[@]} -eq 0 ]; then echo "ok=true" >> $GITHUB_OUTPUT; else echo "ok=false" >> $GITHUB_OUTPUT; echo "Missing: ${missing[*]}"; fi

      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY || vars.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf "%s" "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
        if: steps.check.outputs.ok == 'true'

      - name: Add known_hosts
        env:
          SSH_HOST: ${{ secrets.SSH_HOST || vars.SSH_HOST }}
        run: ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts
        if: steps.check.outputs.ok == 'true'

      - name: Build
        run: |
          test -f index.html || { echo "index.html ausente"; exit 1; }
          echo "Static site ok"

      - name: Test script syntax
        run: bash -n scripts/oci-validate.sh

      - name: Deploy files
        env:
          SSH_HOST: ${{ secrets.SSH_HOST || vars.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER || vars.SSH_USER }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR || vars.REMOTE_DIR }}
          SERVICE_USER: ${{ secrets.SERVICE_USER || vars.SERVICE_USER }}
        run: |
          RDIR=${REMOTE_DIR:-/var/www/hako-website}
          SUSER=${SERVICE_USER:-opc}
          ssh "$SSH_USER@$SSH_HOST" sudo mkdir -p "$RDIR"
          ssh "$SSH_USER@$SSH_HOST" sudo chown -R "$SUSER":"$SUSER" "$RDIR"
          rsync -avz --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude ".trae" \
            --exclude ".gitignore" \
            --exclude ".vercelignore" \
            --rsync-path="sudo rsync" \
            --chown "$SUSER:$SUSER" \
            ./ "$SSH_USER@$SSH_HOST:$RDIR/"
        if: steps.check.outputs.ok == 'true'

      - name: Configure Nginx
        env:
          SSH_HOST: ${{ secrets.SSH_HOST || vars.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER || vars.SSH_USER }}
          NGINX_CONF_DIR: ${{ secrets.NGINX_CONF_DIR || vars.NGINX_CONF_DIR }}
          NGINX_SERVER_NAME: ${{ secrets.NGINX_SERVER_NAME || vars.NGINX_SERVER_NAME }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR || vars.REMOTE_DIR }}
        run: |
          ssh "$SSH_USER@$SSH_HOST" '
            set -e
            CONF_DIR="${NGINX_CONF_DIR:-/etc/nginx/conf.d}"
            CONF_PATH="${CONF_DIR}/hako-website.conf"
            RDIR="${REMOTE_DIR:-/var/www/hako-website}"
            SNAME="${NGINX_SERVER_NAME:-_}"
            if [ -e "/etc/nginx/sites-enabled/default" ]; then sudo rm -f "/etc/nginx/sites-enabled/default"; fi
            sudo mkdir -p "$CONF_DIR"
            sudo tee "$CONF_PATH" > /dev/null <<EOF
server {
  listen 80 default_server;
  listen 3005;
  server_name ${SNAME};
  root ${RDIR};
  index index.html;
  location / {
    try_files \$uri \$uri/ /index.html;
  }
  location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico|webp)$ {
    expires 7d;
    add_header Cache-Control "public, immutable";
  }
}
EOF
            sudo nginx -t
            sudo systemctl reload nginx
          '
        if: steps.check.outputs.ok == 'true'

      - name: Upload validation script
        env:
          SSH_HOST: ${{ secrets.SSH_HOST || vars.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER || vars.SSH_USER }}
        run: scp -q scripts/oci-validate.sh "$SSH_USER@$SSH_HOST:/tmp/oci-validate.sh"
        if: steps.check.outputs.ok == 'true'

      - name: Run validation on OCI
        id: validate_oci
        env:
          SSH_HOST: ${{ secrets.SSH_HOST || vars.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER || vars.SSH_USER }}
          NGINX_SERVER_NAME: ${{ secrets.NGINX_SERVER_NAME || vars.NGINX_SERVER_NAME }}
        run: |
          ssh "$SSH_USER@$SSH_HOST" 'bash /tmp/oci-validate.sh --domain "${NGINX_SERVER_NAME}" --ports 3005,80 --report-path /tmp/oci-report.txt'
          rc=$?
          echo "code=$rc" >> $GITHUB_OUTPUT
        continue-on-error: true
        if: steps.check.outputs.ok == 'true'

      - name: Fetch report
        env:
          SSH_HOST: ${{ secrets.SSH_HOST || vars.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER || vars.SSH_USER }}
        run: scp -q "$SSH_USER@$SSH_HOST:/tmp/oci-report.txt" ./oci-report.txt || true
        if: steps.check.outputs.ok == 'true'

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: oci-report
          path: oci-report.txt

      - name: Fail on validation errors
        if: steps.validate_oci.outputs.code != '0'
        run: |
          echo "validation exit code: ${{ steps.validate_oci.outputs.code }}"
          exit 1

