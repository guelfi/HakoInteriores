name: oci-deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-object-storage:
    runs-on: ubuntu-latest
    if: ${{ secrets.OCI_TENANCY_ID != '' && secrets.OCI_USER_ID != '' && secrets.OCI_FINGERPRINT != '' && secrets.OCI_REGION != '' && secrets.OCI_PRIVATE_KEY != '' && secrets.OCI_BUCKET != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect accidental private keys in repo
        run: |
          set -e
          found=$(find . -type f \( -name "*.pem" -o -name "*.key" \) ! -path "./.github/*" | wc -l)
          if [ "$found" -gt 0 ]; then
            echo "Detected $found key file(s) in repository. Remove them and use GitHub Secrets." && exit 1
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install OCI CLI
        run: pip install oci-cli

      - name: Configure OCI
        env:
          OCI_TENANCY: ${{ secrets.OCI_TENANCY_ID }}
          OCI_USER: ${{ secrets.OCI_USER_ID }}
          OCI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
          OCI_REGION: ${{ secrets.OCI_REGION }}
          OCI_KEY: ${{ secrets.OCI_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.oci
          echo "$OCI_KEY" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          cat > ~/.oci/config <<EOF
          [DEFAULT]
          user=${OCI_USER}
          fingerprint=${OCI_FINGERPRINT}
          key_file=~/.oci/oci_api_key.pem
          tenancy=${OCI_TENANCY}
          region=${OCI_REGION}
          EOF

      - name: Upload to OCI Object Storage
        env:
          OCI_BUCKET: ${{ secrets.OCI_BUCKET }}
        run: |
          oci os object bulk-upload --bucket-name "$OCI_BUCKET" --src-dir . --overwrite true

  deploy-compute-ssh:
    runs-on: ubuntu-latest
    if: ${{ secrets.SSH_HOST != '' && secrets.SSH_USER != '' && secrets.SSH_PRIVATE_KEY != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Validate SSH key format and permissions
        run: |
          set -e
          test -s ~/.ssh/id_rsa || { echo "SSH key file is empty"; exit 1; }
          ls -l ~/.ssh/id_rsa
          perm=$(stat -c %a ~/.ssh/id_rsa || stat -f %Lp ~/.ssh/id_rsa)
          echo "Detected permissions: $perm"
          if [ "$perm" != "600" ]; then
            echo "Invalid permissions on private key; expected 600" && exit 1
          fi
          if ! grep -qE '-----BEGIN (OPENSSH|RSA) PRIVATE KEY-----' ~/.ssh/id_rsa; then
            echo "Private key format not recognized (expected OPENSSH or RSA)" && exit 1
          fi

      - name: Add remote host to known_hosts
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
        run: |
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts

      - name: Test SSH connectivity (handshake)
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          set -e
          ssh -o BatchMode=yes "$SSH_USER@$SSH_HOST" echo ok

      - name: Check passwordless sudo availability
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh "$SSH_USER@$SSH_HOST" 'sudo -n true 2>/dev/null && echo "passwordless sudo: OK" || (echo "passwordless sudo: NOT AVAILABLE"; exit 1)'

      - name: Upload site to remote
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
          SERVICE_USER: ${{ secrets.SERVICE_USER }}
        run: |
          RDIR=${REMOTE_DIR:-/var/www/hako-website}
          SUSER=${SERVICE_USER:-opc}
          ssh "$SSH_USER@$SSH_HOST" sudo mkdir -p "$RDIR"
          ssh "$SSH_USER@$SSH_HOST" sudo chown -R "$SUSER":"$SUSER" "$RDIR"
          rsync -avz --delete --exclude ".git" --exclude ".github" ./ "$SSH_USER@$SSH_HOST:$RDIR/"

      - name: Configurar Nginx para servir estático
        if: ${{ secrets.NGINX_CONF_DIR != '' && secrets.NGINX_SERVER_NAME != '' }}
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          NGINX_CONF_DIR: ${{ secrets.NGINX_CONF_DIR }}
          NGINX_SERVER_NAME: ${{ secrets.NGINX_SERVER_NAME }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
        run: |
          ssh "$SSH_USER@$SSH_HOST" bash -lc '
            set -e
            CONF_DIR="${NGINX_CONF_DIR:-/etc/nginx/conf.d}"
            CONF_PATH="${CONF_DIR}/hako-website.conf"
            RDIR="${REMOTE_DIR:-/var/www/hako-website}"
            {
              echo "server {"
              echo "  listen 80;"
              echo "  listen 3005;"
              echo "  server_name ${NGINX_SERVER_NAME};"
              echo "  root ${RDIR};"
              echo "  index index.html;"
              echo "  location / {"
              echo "    try_files \\$uri \\$uri/ /index.html;"
              echo "  }"
              echo "  location ~* \\.(js|css|png|jpg|jpeg|gif|svg|ico|webp)$ {"
              echo "    expires 7d;"
              echo "    add_header Cache-Control \"public, immutable\";"
              echo "  }"
              echo "}"
            } | sudo tee "$CONF_PATH" > /dev/null
            sudo nginx -t
            sudo systemctl reload nginx
          '

      - name: Teste local (Nginx)
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh "$SSH_USER@$SSH_HOST" bash -lc '
            code=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1/ || true)
            echo "HTTP code: $code"
            if [ "$code" != "200" ] && [ "$code" != "301" ] && [ "$code" != "302" ]; then
              echo "Validação local do Nginx falhou" && exit 1
            fi
          '

      - name: External test (domain via runner)
        if: ${{ secrets.NGINX_SERVER_NAME != '' }}
        env:
          NGINX_SERVER_NAME: ${{ secrets.NGINX_SERVER_NAME }}
        run: |
          code=$(curl -s -o /dev/null -w "%{http_code}" "http://${NGINX_SERVER_NAME}/" || true)
          echo "External HTTP code: $code"
          if [ "$code" != "200" ] && [ "$code" != "301" ] && [ "$code" != "302" ]; then
            echo "External validation falhou" && exit 1
          fi

      - name: External test (IP fallback via runner)
        if: ${{ secrets.NGINX_SERVER_NAME == '' && secrets.SSH_HOST != '' }}
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
        run: |
          code=$(curl -s -o /dev/null -w "%{http_code}" "http://${SSH_HOST}/" || true)
          echo "External HTTP code (IP): $code"
          if [ "$code" != "200" ] && [ "$code" != "301" ] && [ "$code" != "302" ]; then
            echo "External validation (IP) falhou" && exit 1
          fi
